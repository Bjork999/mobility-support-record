<!DOCTYPE html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>移動支援記録表</title>
<link rel="apple-touch-icon" href="tumiki-icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<link rel="stylesheet" href="style.css">
<style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 py-4">
    <div class="w-full max-w-sm bg-white p-6 shadow-lg rounded-lg border border-gray-200 mx-auto py-4">
        <div id="admin-menu" class="text-right mb-4"></div>
        <form id="recordForm" method="POST" action="https://script.google.com/macros/s/AKfycbzOEQBgiH76vRKE1E5TrywpfffPb449dVHhorCCVjDHUR4nDzvfHNHBqn1g9LVmhXu1/exec" target="_blank">
        <div class="border border-gray-400 p-2 text-center mb-6">
            <h1 class="text-xl font-bold tracking-widest">移動支援記録表</h1>
        </div>

        <!-- Date Inputs -->
        <div class="mb-6 flex items-center space-x-2 text-lg flex-wrap">
            <input list="years" id="year" name="year" class="w-24 border-b border-gray-400 text-center" placeholder="YYYY" required>
            <datalist id="years"></datalist>
            <span class="ml-1">年</span>

            <input list="months" id="month" name="month" class="w-16 border-b border-gray-400 text-center" placeholder="MM" required>
            <datalist id="months"></datalist>
            <span class="ml-1">月</span>

            <input list="days" id="day" name="day" class="w-16 border-b border-gray-400 text-center" placeholder="DD" required>
            <datalist id="days"></datalist>
            <span class="ml-1">日</span>
        </div>

        <!-- Time Inputs -->
        <div class="mb-6 flex items-center space-x-4 text-lg flex-wrap">
            <input id="start-time" name="startTime" class="w-24 border-b border-gray-400 text-center" placeholder="開始時間" required>
            <span class="font-bold mx-2">~</span>
            <input id="end-time" name="endTime" class="w-24 border-b border-gray-400 text-center" placeholder="終了時間" required>
        </div>

        <!-- User Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="user-input">利用者</label>
            <input list="users" id="user-input" name="user" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="users">
                <!-- 動的に生成されます -->
            </datalist>
        </div>

        <!-- Supporter 1 Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="supporter1-input">支援員1</label>
            <input list="supporters" id="supporter1-input" name="supporter1" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="supporters">
                <!-- 動的に生成されます -->
            </datalist>
        </div>

        <!-- Supporter 2 Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="supporter2-input">支援員2</label>
            <input list="supporters" id="supporter2-input" name="supporter2" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2">
        </div>

        <!-- Destination Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="destination-input">行き先</label>
            <input list="destinations" id="destination-input" name="destination" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="destinations">
                <!-- 動的に生成されます -->
            </datalist>
        </div>

        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="support-type-input">支援種別</label>
            <input list="support-types" id="support-type-input" name="supportType" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="support-types">
                <!-- 動的に生成されます -->
            </datalist>
        </div>

        <div class="mt-4 pt-2">
            <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4">
                <p class="text-lg font-bold text-gray-900">利用者様確認欄</p>
                <div class="flex items-center">
                    <input type="checkbox" id="check1" name="userCheck" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" required>
                    <label for="check1" class="ml-3 block text-lg font-bold text-gray-900">上記内容を確認しました。</label>
                </div>
                <p class="text-red-600 text-sm mt-2">※利用者様にチェックをもらってください。</p>
            </div>
            <div class="mb-2 flex flex-wrap items-center">
                <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="appearance-input">様子</label>
                <input list="appearances" id="appearance-input" name="appearance" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
                <datalist id="appearances">
                    <!-- 動的に生成されます -->
                </datalist>
            </div>
        </div>
        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mt-4">記録を送信</button>
        </form>
    </div>

    <script>
        console.log("Script loaded and running");

        let supporterSupportTypesMap = {};



        // datalist を更新する関数
        function updateDatalist(datalistId, items) {
            console.log(`📝 ${datalistId} を更新中... アイテム数: ${items.length}`);
            const datalist = document.getElementById(datalistId);
            
            if (!datalist) {
                console.error(`❌ datalist が見つかりません: ${datalistId}`);
                return;
            }
            
            // 既存のオプションをクリア
            datalist.innerHTML = '';
            console.log(`🗑️ ${datalistId} の既存オプションをクリアしました`);
            
            // "-" や空白、null、undefinedを除外して追加
            const filteredItems = items.filter(item =>
                item && item.toString().trim() !== '' && item.toString().trim() !== '-'
            );
            
            filteredItems.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = item;
                datalist.appendChild(option);
                if (index < 3) { // 最初の3つだけログ出力
                    console.log(`➕ ${datalistId}[${index}]: ${item}`);
                }
            });
            
            console.log(`✅ ${datalistId} の更新完了（${filteredItems.length}個のオプション、${items.length - filteredItems.length}個除外）`);
        }

        // デフォルトデータを読み込む関数（フォールバック用）
        function loadDefaultData() {
            console.log("デフォルトデータを使用します");
            
            const defaultUsers = [
                "平林恵子", "空山紘子", "山﨑多恵", "水谷夕美子", "塚原歩美", "上村梨桜", 
                "岩本小耶子", "澤村和浩", "廣瀬久男", "清水健司", "田中真也", "中西俊也", 
                "森本徹", "小泉春夫", "長野崇", "友田陽子", "今井浩", "出戸市朗", 
                "岡田浩嗣", "上林誠", "溝川晧介", "久山大", "渡邉一孝", "塩谷拓也", 
                "藤本和也", "上田治", "仲西美由紀", "田上慶祐", "榎本良児", "千葉美沙代", "菰田絵美子"
            ];

            const defaultSupporters = [
                "亀野 浩", "林 恵美子", "西村 孝仁", "出口  茜視", "木下 裕晃", "廣瀬 優", 
                "木村 凜", "夏原 真咲代", "藤田 梓平", "入江 隆浩", "和田 真由美", "和田 郁人", 
                "南 鑑憲", "森垣  彰", "岩井 泰子", "相馬 芳子", "奥村 さつき", "奥村 紘平", 
                "松下 紗季", "今西 彩"
            ];

            const defaultDestinations = ["散歩", "買い物", "図書館"];
            const defaultSupportTypes = ["移動支援", "行動援護", "通院介助"];
            const defaultAppearances = [
                "気持ちが良さそうだった", "笑顔が多い様子だった", "少し疲れた様子だった", 
                "また外出したいと話していた", "元気な様子だった", "活発に動けた", 
                "少し落ち着きがなかった", "不安な表情が見えた", "コミュニケーションが多かった", "無口な時間があった"
            ];

            updateDatalist('users', defaultUsers);
            updateDatalist('supporters', defaultSupporters);
            updateDatalist('destinations', defaultDestinations);
            updateDatalist('support-types', defaultSupportTypes);
            updateDatalist('appearances', defaultAppearances);
            supporterSupportTypesMap = {}; // デフォルト時は空
        }

        // ページ読み込み時の初期化（高速化版）
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 高速初期化開始");
            
            // 1. 即座に基本UI要素を初期化（日付、時間など）
            initializeDateOptions();
            setCurrentDate();
            setLoggedInUserName();  // ログインユーザーの名前を支援員1に設定
            setupTimeFormatting();
            setupFormSubmission();
            
            // 2. デフォルトデータを即座に読み込み（オフライン対応）
            loadDefaultData();
            
            // 3. 支援員入力イベントの設定
            document.getElementById('supporter1-input').addEventListener('input', function(e) {
                const name = e.target.value.trim();
                updateSupportTypesForSupporter(name);
            });
            
            console.log("✅ 基本初期化完了 - ページ利用可能");
            
            // 4. バックグラウンドで最新データを取得（非ブロッキング）
            setTimeout(() => {
                loadDataFromGAS();
            }, 100); // 100ms後に開始（UIレンダリング優先）
        });
        
        // Google Apps Scriptから最新データを非同期取得
        async function loadDataFromGAS() {
            try {
                console.log("🔄 最新データを取得中...");
                
                const dataUrl = 'https://script.google.com/macros/s/AKfycbzOEQBgiH76vRKE1E5TrywpfffPb449dVHhorCCVjDHUR4nDzvfHNHBqn1g9LVmhXu1/exec?action=getData';
                
                const response = await fetch(dataUrl);
                const responseText = await response.text();
                const data = JSON.parse(responseText);
                
                if (data.success) {
                    // 最新データでリストを更新
                    updateDatalist('users', data.users || []);
                    updateDatalist('supporters', data.supporters || []);
                    updateDatalist('destinations', data.destinations || []);
                    updateDatalist('support-types', data.supportTypes || []);
                    updateDatalist('appearances', data.appearances || []);
                    supporterSupportTypesMap = data.supporterSupportTypes || {};
                    
                    console.log("✅ 最新データ更新完了");
                    showUpdateNotification("📊 最新データに更新されました");
                } else {
                    console.warn("⚠️ データ取得エラー:", data.error);
                    showUpdateNotification("⚠️ データ取得に失敗しました", "warning");
                }
            } catch (error) {
                console.warn("⚠️ ネットワークエラー:", error.message);
                showUpdateNotification("📴 オフラインモードで動作中", "info");
            }
        }
        
        // 通知表示機能
        function showUpdateNotification(message, type = "success") {
            const colors = {
                success: { bg: "#10b981", icon: "✅" },
                warning: { bg: "#f59e0b", icon: "⚠️" },
                info: { bg: "#3b82f6", icon: "ℹ️" }
            };
            
            const color = colors[type] || colors.success;
            
            const notification = document.createElement('div');
            notification.innerHTML = `${color.icon} ${message}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color.bg};
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            document.body.appendChild(notification);
            
            // スライドイン
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 3秒後にスライドアウト
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 日付オプションの初期化
        function initializeDateOptions() {
            const currentYear = new Date().getFullYear();
            const yearsDatalist = document.getElementById('years');
            for (let i = 0; i < 5; i++) {
                const option = document.createElement('option');
                option.value = currentYear - i;
                yearsDatalist.appendChild(option);
            }

            const monthsDatalist = document.getElementById('months');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                monthsDatalist.appendChild(option);
            }

            const daysDatalist = document.getElementById('days');
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                daysDatalist.appendChild(option);
            }
        }

        // 現在の日付を設定
        function setCurrentDate() {
            const now = new Date();
            document.getElementById('year').value = now.getFullYear();
            document.getElementById('month').value = now.getMonth() + 1;
            document.getElementById('day').value = now.getDate();
        }

        // ログインユーザーの名前を支援員1欄に設定
        function setLoggedInUserName() {
            try {
                const userName = sessionStorage.getItem('userName');
                const userId = sessionStorage.getItem('userId');
                
                const supporter1Input = document.getElementById('supporter1-input');
                if (!supporter1Input) {
                    console.error('❌ 支援員1の入力欄が見つかりません');
                    return;
                }
                
                if (userName) {
                    supporter1Input.value = userName;
                    console.log(`✅ 支援員1に自動入力: ${userName}`);
                    
                    // 支援種別の更新をトリガー
                    updateSupportTypesForSupporter(userName);
                } else if (userId) {
                    supporter1Input.value = userId;
                    console.log(`✅ 支援員1に自動入力（ID使用）: ${userId}`);
                    
                    // 支援種別の更新をトリガー
                    updateSupportTypesForSupporter(userId);
                } else {
                    console.warn('⚠️ ログインユーザー情報が見つかりません。index.htmlからアクセスしてください。');
                }
            } catch (error) {
                console.error('❌ ログインユーザー名の設定エラー:', error);
            }
        }

        // 指定された支援員名に基づいて支援種別を更新
        function updateSupportTypesForSupporter(supporterName) {
            try {
                const name = supporterName.trim();
                let types = supporterSupportTypesMap[name];
                
                if (!types || types.length === 0) {
                    // デフォルトの支援種別
                    types = ["移動支援", "行動援護", "通院介助"];
                    console.log(`⚠️ ${name}の支援種別データが見つかりません。デフォルトを使用します。`);
                } else {
                    console.log(`✅ ${name}の支援種別を更新:`, types);
                }
                
                updateDatalist('support-types', types);
            } catch (error) {
                console.error('❌ 支援種別更新エラー:', error);
            }
        }

        // 時間フォーマット設定
        function setupTimeFormatting() {
            function formatTime(event) {
                console.log("formatTime called for:", event.target.id);
                const inputElement = event.target;
                let value = inputElement.value.replace(/[^0-9]/g, '');

                if (value === '') {
                    inputElement.value = '';
                    return;
                }

                let hour, minute;

                if (value.length <= 2) {
                    hour = parseInt(value, 10);
                    minute = 0;
                } else {
                    minute = parseInt(value.slice(-2), 10);
                    hour = parseInt(value.slice(0, -2), 10);
                }

                hour = isNaN(hour) ? 0 : hour;
                minute = isNaN(minute) ? 0 : minute;

                if (hour > 23) {
                    hour = 23;
                }
                if (minute > 59) {
                    minute = 59;
                }

                const formattedHour = hour.toString();
                const formattedMinute = minute.toString().padStart(2, '0');
                inputElement.value = `${formattedHour}:${formattedMinute}`;
            }

            document.getElementById('start-time').addEventListener('blur', formatTime);
            document.getElementById('end-time').addEventListener('blur', formatTime);
        }

        // フォーム送信設定
        function setupFormSubmission() {
            document.getElementById('recordForm').addEventListener('submit', function(event) {
                const formData = new FormData(event.target);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                console.log('送信データ:', data);
                
                // 各フィールドの値を取得
                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const day = document.getElementById('day').value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                const user = document.getElementById('user-input').value;
                const supporter1 = document.getElementById('supporter1-input').value;
                const supporter2 = document.getElementById('supporter2-input').value;
                const destination = document.getElementById('destination-input').value;
                const supportType = document.getElementById('support-type-input').value;
                const appearance = document.getElementById('appearance-input').value;
                const userCheck = document.getElementById('check1').checked ? 'はい' : 'いいえ';
                
                // 確認メッセージを作成
                const confirmMessage = `以下の内容で送信してよろしいですか？

📅 日付: ${year}年${month}月${day}日
⏰ 時間: ${startTime} ～ ${endTime}
👤 利用者: ${user}
👥 支援員1: ${supporter1}
👥 支援員2: ${supporter2}
📍 行き先: ${destination}
🏷️ 支援種別: ${supportType}
😊 様子: ${appearance}
✅ 利用者様確認: ${userCheck}`;
                
                if (!confirm(confirmMessage)) {
                    event.preventDefault();
                    return false;
                }
            });
        }

        // 空白行を非表示にする関数
        function hideEmptyRows(sheet, startRow, endRow) {
          const hiddenRows = [];
          
          try {
            console.log(`空白行チェック: ${startRow}行目～${endRow}行目`);
            
            // 各行をチェック
            for (let row = startRow; row <= endRow; row++) {
              // A列の値を取得
              const valueA = sheet.getRange(row, 1).getValue();
              
              // A列が空白または空文字の場合
              if (!valueA || valueA.toString().trim() === '') {
                // 行を非表示にする
                sheet.hideRows(row, 1);
                hiddenRows.push(row);
              }
            }
            
            console.log(`非表示にした行: ${hiddenRows.length}行`);
            return hiddenRows;
            
          } catch (error) {
            console.error('空白行非表示エラー:', error);
            return hiddenRows;
          }
        }

        // Admin menu
        document.addEventListener('DOMContentLoaded', function() {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'admin') {
                const adminMenu = document.getElementById('admin-menu');
                const button = document.createElement('button');
                button.textContent = 'ユーザー管理';
                button.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-sm';
                button.onclick = function() {
                    window.location.href = 'admin.html';
                };
                adminMenu.appendChild(button);
            }
        });
    </script>
</body></html>